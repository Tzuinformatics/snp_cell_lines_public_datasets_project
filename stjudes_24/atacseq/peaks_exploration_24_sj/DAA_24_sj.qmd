```{r}
library(tidyverse)
library(GenomicRanges)
library(rtracklayer)
```

```{r}
snp_summary <- read.csv("../24_sj_snp_summary_merged.csv")

data_dict <- read.csv("../../GEO_data_dict_sj24_ATAC_RNA_GSM_SRR_mapping.csv")

fastq_files <- data.frame(
                                 check.names = FALSE,
  `fqfiles` = c("24_atac_number_10_SRR13074051_1.fastq.gz", "24_atac_number_10_SRR13074051_2.fastq.gz",
                                                 "24_atac_number_11_SRR13074052_1.fastq.gz",
                                                 "24_atac_number_11_SRR13074052_2.fastq.gz",
                                                 "24_atac_number_12_SRR13074053_1.fastq.gz",
                                                 "24_atac_number_12_SRR13074053_2.fastq.gz",
                                                 "24_atac_number_13_SRR13074054_1.fastq.gz",
                                                 "24_atac_number_13_SRR13074054_2.fastq.gz",
                                                 "24_atac_number_14_SRR13074055_1.fastq.gz",
                                                 "24_atac_number_14_SRR13074055_2.fastq.gz",
                                                 "24_atac_number_15_SRR13074056_1.fastq.gz",
                                                 "24_atac_number_15_SRR13074056_2.fastq.gz",
                                                 "24_atac_number_16_SRR13074057_1.fastq.gz",
                                                 "24_atac_number_16_SRR13074057_2.fastq.gz",
                                                 "24_atac_number_17_SRR13074058_1.fastq.gz",
                                                 "24_atac_number_17_SRR13074058_2.fastq.gz",
                                                 "24_atac_number_18_SRR13074059_1.fastq.gz",
                                                 "24_atac_number_18_SRR13074059_2.fastq.gz",
                                                 "24_atac_number_19_SRR13074060_1.fastq.gz",
                                                 "24_atac_number_19_SRR13074060_2.fastq.gz",
                                                 "24_atac_number_1_SRR13074042_1.fastq.gz",
                                                 "24_atac_number_1_SRR13074042_2.fastq.gz",
                                                 "24_atac_number_20_SRR13074061_1.fastq.gz",
                                                 "24_atac_number_20_SRR13074061_2.fastq.gz",
                                                 "24_atac_number_21_SRR13074062_1.fastq.gz",
                                                 "24_atac_number_21_SRR13074062_2.fastq.gz",
                                                 "24_atac_number_22_SRR13074063_1.fastq.gz",
                                                 "24_atac_number_22_SRR13074063_2.fastq.gz",
                                                 "24_atac_number_23_SRR13074064_1.fastq.gz",
                                                 "24_atac_number_23_SRR13074064_2.fastq.gz",
                                                 "24_atac_number_24_SRR13074065_1.fastq.gz",
                                                 "24_atac_number_24_SRR13074065_2.fastq.gz",
                                                 "24_atac_number_2_SRR13074043_1.fastq.gz",
                                                 "24_atac_number_2_SRR13074043_2.fastq.gz",
                                                 "24_atac_number_3_SRR13074044_1.fastq.gz",
                                                 "24_atac_number_3_SRR13074044_2.fastq.gz",
                                                 "24_atac_number_4_SRR13074045_1.fastq.gz",
                                                 "24_atac_number_4_SRR13074045_2.fastq.gz",
                                                 "24_atac_number_5_SRR13074046_1.fastq.gz",
                                                 "24_atac_number_5_SRR13074046_2.fastq.gz",
                                                 "24_atac_number_6_SRR13074047_1.fastq.gz",
                                                 "24_atac_number_6_SRR13074047_2.fastq.gz",
                                                 "24_atac_number_7_SRR13074048_1.fastq.gz",
                                                 "24_atac_number_7_SRR13074048_2.fastq.gz",
                                                 "24_atac_number_8_SRR13074049_1.fastq.gz",
                                                 "24_atac_number_8_SRR13074049_2.fastq.gz",
                                                 "24_atac_number_9_SRR13074050_1.fastq.gz",
                                                 "24_atac_number_9_SRR13074050_2.fastq.gz")
)


# Dependencies
library(dplyr)
library(stringr)

# --- FASTQ annotation: add SRR_ID and join to data_dict ---
fastq_annotated <- fastq_files %>%
  mutate(SRR_ID = str_extract(fqfiles, "SRR[0-9]+")) %>%
  left_join(data_dict, by = "SRR_ID")

# Quick check
head(fastq_annotated)

# --- Harmonize atac_number in both datasets ---
# From snp_summary$Sample
snp_summary <- snp_summary %>%
  mutate(atac_number = str_extract(Sample, "24_atac_number_[0-9]+"))

# From fastq_annotated$fqfiles
fastq_annotated <- fastq_annotated %>%
  mutate(atac_number = str_extract(fqfiles, "24_atac_number_[0-9]+"))

# --- Build mapping: atac_number -> Sample_Title (unique) ---
atac_to_title <- fastq_annotated %>%
  select(atac_number, Sample_Title) %>%
  distinct()

# --- Update snp_summary with GEO titles ---
snp_summary_updated <- snp_summary %>%
  left_join(atac_to_title, by = "atac_number") %>%
  mutate(Sample = coalesce(Sample_Title, Sample)) %>%   # keep original Sample if title missing
  select(-atac_number, -Sample_Title)

# Quick check
head(snp_summary_updated)

# ====== Packages ======
suppressPackageStartupMessages({
    library(ggplot2)
    library(dplyr)
    library(tidyr)
})

# snp_summary_updated is assumed to be your data.frame with columns:
# Sample, Ref, A, C, G, T, N, Total, ALT.

# ====== Long format for stacked bars (A/C/G/T/N) ======
snp_long <- snp_summary_updated %>%
    dplyr::select(Sample, A, C, G, T, N) %>%
    tidyr::pivot_longer(cols = c(A, C, G, T, N),
                        names_to = "Base",
                        values_to = "Reads")

# Optional: order samples by total reads (descending) for readability
sample_order <- snp_summary_updated %>%
    dplyr::mutate(Total_reads = A + C + G + T + N) %>%
    dplyr::arrange(dplyr::desc(Total_reads)) %>%
    dplyr::pull(Sample)

snp_long <- snp_long %>%
    dplyr::mutate(Sample = factor(Sample, levels = sample_order))

# ====== Stacked bar plot (counts) ======
ggplot(snp_long, aes(x = Sample, y = Reads, fill = Base)) +
    geom_bar(stat = "identity") +
    labs(x = "Sample",
         y = "Number of reads at SNP",
         fill = "Base") +
    theme_minimal(base_size = 12) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


# Required
library(dplyr)

# 1) Your manual genotype calls
genotype_map <- tibble::tribble(
  ~Sample,         ~Genotype,
  "ATAC_10_REP1",  "TT",
  "ATAC_11_REP1",  "TC",
  "ATAC_12_REP1",  "TT",
  "ATAC_13_REP1",  "CC",
  "ATAC_14_REP1",  "CC",
  "ATAC_15_REP1",  "CC",
  "ATAC_16_REP1",  "TC",
  "ATAC_17_REP1",  "TT",
  "ATAC_18_REP1",  "TT",
  "ATAC_19_REP1",  "TC",
  "ATAC_1_REP1",   "TT",
  "ATAC_20_REP1",  "TT",
  "ATAC_21_REP1",  "TC",
  "ATAC_22_REP1",  "TC",
  "ATAC_23_REP1",  "TT",
  "ATAC_24_REP1",  "TT",
  "ATAC_2_REP1",   "TC",
  "ATAC_3_REP1",   "TT",
  "ATAC_4_REP1",   "TC",
  "ATAC_5_REP1",   "TT",
  "ATAC_6_REP1",   "TC",
  "ATAC_7_REP1",   "CC",
  "ATAC_8_REP1",   "TC",
  "ATAC_9_REP1",   "CC"
)

# 2) Join onto your summary table
snp_summary_with_geno <- snp_summary_updated %>%
  dplyr::left_join(genotype_map, by = "Sample")

# 3) Quick sanity checks (optional)
# Any samples in your map not present in the summary?
setdiff(genotype_map$Sample, snp_summary_updated$Sample)
# Any samples without a genotype after join?
snp_summary_with_geno %>% dplyr::filter(is.na(Genotype))

# 4) Save (optional)
write.csv(snp_summary_with_geno,"atac_sj19_snp_summary_with_geno.csv")

```

